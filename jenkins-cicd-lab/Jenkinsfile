pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    AWS_REGION = 'us-east-1'
    ECR_REPO   = '646977526611.dkr.ecr.us-east-1.amazonaws.com/cicd-lab/demo-app'
    IMAGE_NAME = 'go-microservice'
  }

  stages {
    stage('Build image') {
      steps {
        sh '''
          set -euo pipefail
          SHA=$(git rev-parse --short HEAD)
          echo "Building image with tag: ${SHA}"
          docker build -t "${ECR_REPO}:${SHA}" .
        '''
      }
    }

    stage('Login to ECR') {
      steps {
        sh '''
          set -euo pipefail
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "$(echo "${ECR_REPO}" | cut -d/ -f1)"
        '''
      }
    }

    stage('Push to ECR') {
      steps {
        sh '''
          set -euo pipefail
          SHA=$(git rev-parse --short HEAD)
          docker push "${ECR_REPO}:${SHA}"
          docker tag "${ECR_REPO}:${SHA}" "${ECR_REPO}:latest"
          docker push "${ECR_REPO}:latest"
        '''
      }
    }
  } // <-- closes stages

  post {
    success {
      sh 'docker system prune -af || true'
    }
  }
} // <-- closes pipeline